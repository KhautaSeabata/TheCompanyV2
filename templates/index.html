<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volatility 25 Charts</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #121212;
      color: white;
      margin: 0;
      padding: 0;
    }
    canvas {
      background: #1e1e1e;
      margin: 10px auto;
      display: block;
      max-width: 100%;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px;
    }
    button {
      padding: 8px 16px;
      background: #333;
      border: 1px solid #888;
      color: white;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background: #555;
    }
  </style>
</head>
<body>
  <h2 style="text-align: center;">Volatility 25 Charts</h2>
  <div class="controls">
    <button onclick="scrollToLatest()">Scroll to Latest</button>
    <button onclick="toggleAutoScroll()">
      <span id="autoScrollStatus">Pause Auto-Scroll</span>
    </button>
  </div>

  <canvas id="tickChart" height="150"></canvas>
  <canvas id="oneMinChart" height="200"></canvas>
  <canvas id="fiveMinChart" height="200"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "vix75-f6684.firebaseapp.com",
      databaseURL: "https://vix75-f6684-default-rtdb.firebaseio.com",
      projectId: "vix75-f6684",
      storageBucket: "vix75-f6684.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const maxPoints = 100;
    let autoScroll = true;

    // Create charts
    const tickChart = new Chart(document.getElementById("tickChart"), {
      type: "line",
      data: { labels: [], datasets: [{ label: "Tick", data: [], borderColor: "#00ffcc", tension: 0.3 }] },
      options: { animation: false, responsive: true, scales: { x: { ticks: { color: "#ccc" } }, y: { ticks: { color: "#ccc" } } } }
    });

    const oneMinChart = new Chart(document.getElementById("oneMinChart"), {
      type: "candlestick",
      data: { datasets: [{ label: "1-Min Candles", data: [], borderColor: "#1aff1a", borderWidth: 1 }] },
      options: { animation: false, responsive: true, scales: { x: { ticks: { color: "#ccc" } }, y: { ticks: { color: "#ccc" } } } }
    });

    const fiveMinChart = new Chart(document.getElementById("fiveMinChart"), {
      type: "candlestick",
      data: { datasets: [{ label: "5-Min Candles", data: [], borderColor: "#ffcc00", borderWidth: 1 }] },
      options: { animation: false, responsive: true, scales: { x: { ticks: { color: "#ccc" } }, y: { ticks: { color: "#ccc" } } } }
    });

    function scrollToLatest() {
      autoScroll = true;
      document.getElementById("autoScrollStatus").innerText = "Pause Auto-Scroll";
    }

    function toggleAutoScroll() {
      autoScroll = !autoScroll;
      document.getElementById("autoScrollStatus").innerText = autoScroll ? "Pause Auto-Scroll" : "Resume Auto-Scroll";
    }

    function toTimeLabel(epoch) {
      const date = new Date(epoch * 1000);
      return `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`;
    }

    function toCandle(time, o, h, l, c) {
      return { x: time * 1000, o, h, l, c };
    }

    // Fetch live tick data
    db.ref("ticks/R_25").on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const sorted = Object.values(data).sort((a, b) => a.epoch - b.epoch).slice(-maxPoints);

      tickChart.data.labels = sorted.map(item => toTimeLabel(item.epoch));
      tickChart.data.datasets[0].data = sorted.map(item => item.quote);
      tickChart.update();

      if (autoScroll) {
        tickChart.canvas.parentNode.scrollTop = tickChart.canvas.parentNode.scrollHeight;
      }
    });

    // Fetch 1-min candles
    db.ref("1minVix25").on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const sorted = Object.values(data).sort((a, b) => a.epoch - b.epoch).slice(-maxPoints);
      oneMinChart.data.datasets[0].data = sorted.map(c =>
        toCandle(c.epoch, c.open, c.high, c.low, c.close)
      );
      oneMinChart.update();
    });

    // Fetch 5-min candles
    db.ref("5minVix25").on("value", (snapshot) => {
      const data = snapshot.val();
      if (!data) return;
      const sorted = Object.values(data).sort((a, b) => a.epoch - b.epoch).slice(-maxPoints);
      fiveMinChart.data.datasets[0].data = sorted.map(c =>
        toCandle(c.epoch, c.open, c.high, c.low, c.close)
      );
      fiveMinChart.update();
    });

    // Add candlestick chart type (since Chart.js core doesn't support it directly)
    Chart.register({
      id: 'candlestick',
      beforeInit(chart) {
        chart.config.type = 'bar';
        chart.config.data.datasets.forEach(ds => {
          ds.barPercentage = 1.0;
          ds.categoryPercentage = 1.0;
        });
      }
    });

    Chart.defaults.candlestick = Chart.defaults.bar;
  </script>
</body>
</html>
