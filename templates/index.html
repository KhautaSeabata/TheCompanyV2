<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volatility 75 Live Chart</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #FFFFFF;
            color: #000000;
            font-family: Arial, sans-serif;
        }
        h1 {
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            color: #000000;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            background-color: #FFFFFF;
            border: 1px solid #000000;
        }
        .tick-info {
            margin-top: 10px;
            font-size: 16px;
            text-align: center;
            color: #000000;
        }
    </style>
</head>
<body>
    <h1>Volatility 75 Live Chart</h1>
    <div id="chart" class="chart-container"></div>
    <div id="tick-info" class="tick-info">Latest Tick: Waiting for data...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

    <script>
        const SYMBOL = "R_75";
        let chart, lineSeries;

        // Initialize Socket.IO
        const socket = io({ transports: ['websocket', 'polling'] });

        // Create line chart
        function createChart() {
            const container = document.getElementById('chart');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: '#FFFFFF' },
                    textColor: '#000000',
                },
                grid: {
                    vertLines: { color: '#000000' },
                    horzLines: { color: '#000000' },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: true,
                    borderColor: '#000000',
                },
                rightPriceScale: {
                    borderColor: '#000000',
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
            });

            lineSeries = chart.addLineSeries({
                color: '#000000',
                lineWidth: 1,
                title: 'R_75 Tick Price'
            });

            new ResizeObserver(entries => {
                entries.forEach(entry => {
                    chart.applyOptions({ width: entry.contentRect.width, height: entry.contentRect.height });
                });
            }).observe(container);

            console.log('Chart initialized for Volatility 75');
        }

        // Update chart and tick info
        function updateChart(data) {
            if (lineSeries && data && typeof data.time === 'number' && typeof data.value === 'number') {
                console.log('Updating chart with tick:', data);
                lineSeries.update({ time: data.time, value: data.value });
                chart.timeScale().fitContent();

                // Update tick info display
                const tickInfo = document.getElementById('tick-info');
                const timeString = new Date(data.time * 1000).toLocaleString();
                tickInfo.textContent = `Latest Tick: Price = ${data.value.toFixed(5)}, Time = ${timeString}`;
            } else {
                console.error('Invalid tick data format:', data);
            }
        }

        // Set initial chart data
        function setInitialChartData(data) {
            if (lineSeries && Array.isArray(data) && data.length > 0) {
                const validData = data.filter(d => typeof d.time === 'number' && typeof d.value === 'number');
                if (validData.length > 0) {
                    console.log(`Setting initial tick data: ${validData.length} points`, validData.slice(-5));
                    lineSeries.setData(validData);
                    chart.timeScale().fitContent();

                    // Display the latest tick from initial data
                    const latestTick = validData[validData.length - 1];
                    const tickInfo = document.getElementById('tick-info');
                    const timeString = new Date(latestTick.time * 1000).toLocaleString();
                    tickInfo.textContent = `Latest Tick: Price = ${latestTick.value.toFixed(5)}, Time = ${timeString}`;
                } else {
                    console.error('No valid initial tick data:', data);
                }
            } else {
                console.error('Invalid initial data or line series not initialized:', data);
            }
        }

        // Socket.IO handlers
        socket.on('connect', () => {
            console.log('Connected to Flask Socket.IO');
            socket.emit('request_initial_data', { symbol: SYMBOL });
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });

        socket.on('initial_tick_data', (msg) => {
            if (msg.symbol === SYMBOL) {
                console.log('Received initial tick data:', msg.data);
                setInitialChartData(msg.data);
            }
        });

        socket.on('tick_update', (msg) => {
            if (msg.symbol === SYMBOL) {
                console.log('Received tick update:', msg.data);
                updateChart(msg.data);
            }
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from Flask Socket.IO');
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing chart...');
            createChart();
        });
    </script>
</body>
</html>
