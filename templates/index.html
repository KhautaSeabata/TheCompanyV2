<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volatility 75 Live Data</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            color: #e2e8f0;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            background-color: #2d3748;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .chart-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #cbd5e0;
        }
        .alert-item {
            background-color: #2d3748;
            border-left: 4px solid;
            border-color: #4CAF50;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.25rem;
        }
        .alert-item.sell {
            border-color: #EF5350;
        }
        .grid-cols-1-md-2 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        @media (min-width: 768px) {
            .grid-cols-1-md-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <h1 class="text-3xl md:text-4xl font-bold text-center mb-8 text-blue-400">Volatility 75 Live Data</h1>

    <div class="grid grid-cols-1-md-2 gap-6">
        <div>
            <h3 class="chart-title text-center text-lg">Volatility 75 - Tick Price vs Time</h3>
            <div id="chart" class="chart-container"></div>
        </div>
        <div>
            <h3 class="chart-title text-center text-lg">Trading Alerts</h3>
            <div id="alerts" class="space-y-2"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>

    <script>
        const SYMBOL = "R_75";
        let chart, lineSeries;

        // Initialize Socket.IO
        const socket = io({ transports: ['websocket', 'polling'] });

        // Create line chart
        function createChart() {
            const container = document.getElementById('chart');
            chart = LightweightCharts.createChart(container, {
                width: container.clientWidth,
                height: container.clientHeight,
                layout: {
                    background: { color: '#2d3748' },
                    textColor: '#cbd5e0',
                },
                grid: {
                    vertLines: { color: '#4a5568' },
                    horzLines: { color: '#4a5568' },
                },
                timeScale: {
                    timeVisible: true,
                    secondsVisible: true,
                    borderColor: '#4a5568',
                },
                rightPriceScale: {
                    borderColor: '#4a5568',
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
            });

            lineSeries = chart.addLineSeries({
                color: '#63b3ed',
                lineWidth: 2,
                title: 'R_75 Tick Price'
            });

            new ResizeObserver(entries => {
                entries.forEach(entry => {
                    chart.applyOptions({ width: entry.contentRect.width, height: entry.contentRect.height });
                });
            }).observe(container);

            console.log('Chart initialized for Volatility 75');
        }

        // Update chart data
        function updateChart(data) {
            if (lineSeries && data && typeof data.time === 'number' && typeof data.value === 'number') {
                console.log('Updating chart with tick:', data);
                lineSeries.update({ time: data.time, value: data.value });
                chart.timeScale().fitContent();
            } else {
                console.error('Invalid tick data format:', data);
            }
        }

        // Set initial chart data
        function setInitialChartData(data) {
            if (lineSeries && Array.isArray(data) && data.length > 0) {
                const validData = data.filter(d => typeof d.time === 'number' && typeof d.value === 'number');
                if (validData.length > 0) {
                    console.log(`Setting initial tick data: ${validData.length} points`, validData.slice(-5));
                    lineSeries.setData(validData);
                    chart.timeScale().fitContent();
                } else {
                    console.error('No valid initial tick data:', data);
                }
            } else {
                console.error('Invalid initial data or line series not initialized:', data);
            }
        }

        // Handle alerts
        function addAlert(alert) {
            console.log('Received alert:', alert);
            const alertsContainer = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert-item ${alert.direction.toLowerCase()}`;
            alertDiv.innerHTML = `
                <p><strong>${alert.type}</strong> (${alert.direction})</p>
                <p>Price: ${alert.price.toFixed(5)}</p>
                <p>Confidence: ${(alert.confidence * 100).toFixed(1)}%</p>
                <p>${alert.description}</p>
                <p class="text-sm text-gray-400">Expires: ${new Date(alert.expiry).toLocaleString()}</p>
            `;
            alertsContainer.prepend(alertDiv);
            while (alertsContainer.children.length > 10) {
                alertsContainer.removeChild(alertsContainer.lastChild);
            }
        }

        // Socket.IO handlers
        socket.on('connect', () => {
            console.log('Connected to Flask Socket.IO');
            socket.emit('request_initial_data', { symbol: SYMBOL });
        });

        socket.on('connect_error', (error) => {
            console.error('Socket.IO connection error:', error);
        });

        socket.on('initial_tick_data', (msg) => {
            if (msg.symbol === SYMBOL) {
                console.log('Received initial tick data:', msg.data);
                setInitialChartData(msg.data);
            }
        });

        socket.on('tick_update', (msg) => {
            if (msg.symbol === SYMBOL) {
                console.log('Received tick update:', msg.data);
                updateChart(msg.data);
            }
        });

        socket.on('alert_update', (alert) => {
            console.log('Received alert update:', alert);
            addAlert(alert);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from Flask Socket.IO');
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing chart...');
            createChart();
        });
    </script>
</body>
</html>
